{% load static %}
<div id="messageBox"></div>

<script>
function showMessage(msg, type="success") {
    let box = document.getElementById("messageBox");
    box.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
}


</script>
<!-- Job Card -->
<div class="card shadow-sm p-4 border-0">
    <!-- Company Logo + Job Title -->
    <div class="d-flex align-items-center mb-3">
        {% if job.company.company_logo %}
        <img src="{{ job.company.company_logo.url }}" class="rounded-circle me-3 shadow-sm border" width="60" height="60" style="object-fit: cover;">
        {% else %}
        <img src="{% static 'app/default-company.png' %}" class="rounded-circle me-3 shadow-sm border" width="60" height="60" style="object-fit: cover;">
        {% endif %}
        <div>
            <h4 class="fw-bold mb-1 text-primary"><i class="fas fa-briefcase me-2"></i>{{ job.job_title }}</h4>
            <p class="text-muted mb-0"><i class="fas fa-building me-1"></i>{{ job.company.company_name }}</p>
        </div>
    </div>

    <!-- Job Details -->
    <ul class="list-unstyled mt-3 mb-4">
        <li class="mb-2"><i class="fas fa-map-marker-alt text-primary me-2"></i><strong>Location:</strong> {{ job.location }}</li>
        <li class="mb-2"><i class="fas fa-money-bill-wave text-success me-2"></i><strong>Salary:</strong> {{ job.salary_package }}</li>
        <li class="mb-2"><i class="fas fa-briefcase text-warning me-2"></i><strong>Experience Required:</strong> {{ job.experience_required }}</li>
        <li class="mb-2"><i class="fas fa-graduation-cap text-info me-2"></i><strong>Qualifications:</strong> {{ job.qualifications }}</li>
    </ul>

    <!-- Job Description -->
    <div class="mb-3">
        <h6 class="fw-bold"><i class="fas fa-file-alt me-2 text-secondary"></i>Job Description:</h6>
        <p class="text-muted">{{ job.job_description|linebreaks }}</p>
    </div>

    <!-- Company Info -->
    {% if job.company.website %}
    <p class="mb-1"><i class="fas fa-globe text-primary me-2"></i><strong>Website:</strong> <a href="{{ job.company.website }}" target="_blank">{{ job.company.website }}</a></p>
    {% endif %}
    {% if job.company.email %}
    <p><i class="fas fa-envelope text-danger me-2"></i><strong>Email:</strong> <a href="mailto:{{ job.company.email }}">{{ job.company.email }}</a></p>
    {% endif %}

    <!-- Action Buttons -->
    <div class="d-flex gap-2 mt-3">
        <a href="#" class="btn btn-primary flex-fill apply-btn" data-job-id="{{ job.id }}">
            <i class="fas fa-paper-plane"></i> Apply Now
        </a>
        <button class="btn btn-outline-danger flex-fill save-btn" data-job-id="{{ job.id }}">
            <i class="fas fa-heart"></i> Save Job
        </button>
    </div>
</div>

<!-- Modal (for Apply Form) -->
<div class="modal fade" id="applyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Apply for Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="applyModalContent">
                <!-- AJAX form will be injected here -->
            </div>
        </div>
    </div>
</div>

<style>
.apply-btn, .save-btn {
    transition: all 0.3s ease;
}
.apply-btn:hover, .save-btn:hover {
    transform: scale(1.05);
}
.save-btn.saved {
    background-color: #dc3545 !important;
    color: #fff !important;
}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).off("click", ".apply-btn").on("click", ".apply-btn", function(e) {
    e.preventDefault();
    let jobId = $(this).data("job-id");

    $.get(`/apply-job/${jobId}/`, function(data) {
        $("#applyModalContent").html(data);
        $("#applyModal").modal("show");
    }).fail(function() {
        alert("Error loading application form.");
    });
});

$(document).on("submit", "#applyJobForm", function(e) {
    e.preventDefault();
    let formData = new FormData(this);

    $.ajax({
        type: "POST",
        url: $(this).attr("action"),
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            alert(response.message);
            $("#applyModal").modal("hide");
        },
        error: function() {
            alert("Error submitting application.");
        }
    });
});

// Save Job button AJAX
// Save Job button AJAX
$(document).off("click", ".save-btn").on("click", ".save-btn", function(e) {
    e.preventDefault();
    let button = $(this);
    let jobId = button.data("job-id");

    $.post(`/save-job/${jobId}/`, { csrfmiddlewaretoken: '{{ csrf_token }}' }, function(response) {
        if (response.success) {
            // Show success message above card
            showMessage(response.message, "success");
            button.addClass("saved").html('<i class="fas fa-check"></i> Saved');
        } else {
            showMessage(response.message, "danger");
            button.removeClass("saved").html('<i class="fas fa-heart"></i> Save Job');
        }
    }).fail(function() {
        showMessage("Error saving job.", "danger");
    });
});

</script>
